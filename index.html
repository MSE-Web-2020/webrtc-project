<!doctype html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Webrtc聊天室</title>
    <link rel="stylesheet" href="css/index.css">
    <script src="https://cdn.bootcss.com/jquery/3.4.1/jquery.min.js"></script>
</head>
<body>
<div id="chat">
    <div class="msgs" id="msgs"></div>
    <input type="file" id="fileIpt" class="fileIpt">
    <button id="sendFileBtn" class="sendFileBtn">发送文件</button>
    <input type="text" id="msgIpt" class="msgIpt" title="消息">
    <button id="sendBtn" class="sendBtn">发送</button>
</div>
<div id="videos">
    <video id="me" autoplay></video>
</div>
<div id="files">
</div>
<div id="vueapp">
    <div id= "control-button">
        <button id="record">start</button>
        <button id="save">保存</button>
    </div>
</div>
<script src="js/SkyRTC-client.js"></script>
<script src="js/conn.js"></script>
<script>
var recorderFile, mediaRecorder
$('#record').click(function(){
    if($(this).text() == 'start'){
        let buffer = []
        mediaRecorder = new MediaRecorder($('#me')[0].srcObject);
        mediaRecorder.ondataavailable = e=>buffer.push(e.data)
        mediaRecorder.onstop = e=>{
            recorderFile = new Blob(buffer, {'type':'video/mp4'})
            buffer = []
            alert("录制成功!")
        }
        mediaRecorder.start();
        $('#me').css('border',"3px solid yellow");
        $(this).text('stop')
    }else{
        mediaRecorder.stop()
        $('#me').css('border',"1px solid green")
        $(this).text('start')
    }
})

$('#save').click(()=>{
    confirm('确定要保存当前录制内容吗？')
    &&$('<a>').attr({
        'href':window.URL.createObjectURL(recorderFile),
        'download':`MSE-${(new Date).toISOString().replace(/:|\./g,'-')}.mp4`,
    }).appendTo('body').bind('click',function(){this.click()}).click().remove()
})
</script>
</body>
</html>
